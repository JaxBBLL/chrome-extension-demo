let a=null,c={};const h="http://192.168.80.12:9566";l();chrome.runtime.onMessage.addListener((t,e,n)=>(console.log("background",t),t.type=="LOGIN_CHECK"?r(o=>{n({type:t.type,data:o,message:"\u64CD\u4F5C\u6210\u529F"})}):t.type=="SYNC_START"?g(o=>{n({type:t.type,data:o,message:"\u64CD\u4F5C\u6210\u529F"})}):t.type==="SYNC_CLOSE"?(l(),n({type:t.type,message:"\u540C\u6B65\u5173\u95ED"})):n({type:t.type,message:"\u672A\u77E5\u64CD\u4F5C"}),!0));function f(t,e){chrome.notifications.getPermissionLevel(n=>{n=="granted"?chrome.notifications.create(t,{type:"basic",title:"\u63D0\u793A",message:e,iconUrl:"images/logo.png",requireInteraction:!1}):alert(e)})}function s(){return new Promise((t,e)=>{chrome.cookies.getAll({url:"https://b2bservice.baidu.com"},n=>{const o=n.map(i=>i.name+"="+i.value).join("; ");t(o)})})}function r(t){fetch("https://b2bservice.baidu.com/api/auth/getuserinfo",{method:"GET"}).then(e=>e.json()).then(e=>{var n=e.data&&e.data.isLogin||0;chrome.storage.local.set({isLogin:n}),c=e;var o=c.data&&c.data.ucName||"";s().then(i=>{n==1?s().then(m=>{t({isLogin:1,token:e.inf.csrf_token,cookies:m,ucName:o})}):n==0&&t({isLogin:0,token:"",cookies:i,ucName:o})})}).catch(()=>{chrome.storage.local.set({isLogin:0});var e="";t({isLogin:0,token:"",cookies:"",ucName:e})})}function g(t){clearTimeout(a),r(e=>{console.log("getLoginState",e),e.isLogin==0?(chrome.notifications.clear("notify1"),f("notify1","\u540C\u6B65\u4E4B\u524D\u7528\u6237\u9700\u8981\u767B\u5F55")):e.isLogin==1&&(u(e),a=setTimeout(()=>{g(t)},1e3*5*60)),chrome.runtime.sendMessage({from:"background",type:"SYNC_END",data:e}),t&&t(e),chrome.storage.local.set({isSync:e.isLogin})})}function l(){clearTimeout(a),chrome.storage.local.set({isSync:0})}function u(t){chrome.storage.local.get("host",e=>{console.log("get host",e);var n=e.host||h;chrome.storage.local.set({host:n}),fetch(n+"/kb/secret_key/update",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}).then(o=>o.json()).then(o=>{if(console.log(o),o.code==200&&o.data){const i=new Date().toLocaleString();chrome.storage.local.set({time:i}),chrome.runtime.sendMessage({from:"background",type:"SYNC_SUCCESS",data:i})}}).catch(o=>{console.log(o)})})}
